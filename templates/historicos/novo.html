{% extends "base.html" %}

{% block title %}{% if √©_edicao %}Editar Hist√≥rico{% else %}Novo Hist√≥rico{% endif %}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi {% if √©_edicao %}bi-pencil-square{% else %}bi-file-earmark-plus{% endif %}"></i> {% if √©_edicao %}Editar Hist√≥rico{% else %}Criar Novo Hist√≥rico{% endif %}</h2>
        <hr>
        <!-- Indicador de Auto-Save -->
        <div class="alert alert-success" id="alertAutoSave" style="display:none;">
            <i class="bi bi-cloud-check"></i> <strong>Auto-Save Ativado:</strong> 
            Suas altera√ß√µes s√£o salvas automaticamente. 
            Voc√™ pode sair e voltar a qualquer momento.
            <span class="ms-3" id="ultimoSalvamento"></span>
        </div>
    </div>
</div>

<form method="POST" action="{% if √©_edicao %}{{ url_for('historicos.editar', id=historico.id) }}{% else %}{{ url_for('historicos.novo') }}{% endif %}">
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Informa√ß√µes do Hist√≥rico</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-primary">
                <i class="bi bi-info-circle"></i> <strong>Passo 1:</strong> Escolha primeiro o <strong>N√≠vel</strong> (Fundamental/M√©dio/Supletivo/EJA) para carregar as op√ß√µes corretas.
            </div>
            
            <div class="row">
                <!-- PASSO 1: N√çVEL -->
                <div class="col-md-12 mb-4">
                    <label for="nivel" class="form-label fs-5 text-primary">
                        <i class="bi bi-1-circle-fill"></i> N√≠vel de Ensino *
                    </label>
                        <select class="form-select form-select-lg" id="nivel" name="nivel" required>
                        <option value="">Escolha o n√≠vel de ensino...</option>
                        <option value="Fundamental 9 Anos" {% if √©_edicao and historico.nivel == 'Fundamental 9 Anos' %}selected{% endif %}>Ensino Fundamental - 9 Anos (1¬∫ ao 9¬∫)</option>
                        <option value="Fundamental 8 S√©ries" {% if √©_edicao and historico.nivel == 'Fundamental 8 S√©ries' %}selected{% endif %}>Ensino Fundamental - 8 S√©ries (1¬™ a 8¬™)</option>
                        <option value="M√©dio" {% if √©_edicao and historico.nivel == 'M√©dio' %}selected{% endif %}>Ensino M√©dio</option>
                        <option value="Supletivo Fundamental" {% if √©_edicao and historico.nivel == 'Supletivo Fundamental' %}selected{% endif %}>Supletivo - Ensino Fundamental</option>
                        <option value="Supletivo M√©dio" {% if √©_edicao and historico.nivel == 'Supletivo M√©dio' %}selected{% endif %}>Supletivo - Ensino M√©dio</option>
                        <option value="EJA Fundamental" {% if √©_edicao and historico.nivel == 'EJA Fundamental' %}selected{% endif %}>EJA - Ensino Fundamental</option>
                        <option value="EJA M√©dio" {% if √©_edicao and historico.nivel == 'EJA M√©dio' %}selected{% endif %}>EJA - Ensino M√©dio</option>
                    </select>
                </div>
            </div>
            
            <hr class="my-4">
            
            <div id="camposAdicionais">
                <!-- PASSO 2: Dados do Aluno -->
                <div class="alert alert-primary">
                    <i class="bi bi-info-circle"></i> <strong>Passo 2:</strong> Selecione o <strong>Aluno</strong> para este hist√≥rico.
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-12 mb-3">
                        <label for="aluno_id" class="form-label fs-5 text-primary">
                            <i class="bi bi-2-circle-fill"></i> Aluno *
                        </label>
                        <select class="form-select form-select-lg" id="aluno_id" name="aluno_id" required>
                            <option value="">Selecione um aluno...</option>
                            {% for aluno in alunos %}
                            <option value="{{ aluno.id }}" {% if √©_edicao and historico.aluno_id == aluno.id %}selected{% endif %}>{{ aluno.nome_completo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <!-- PASSO 3: Dados dos Anos Letivos -->
                <div class="alert alert-success">
                    <i class="bi bi-info-circle"></i> <strong>Passo 3:</strong> Adicione os <strong>Anos Letivos</strong> cursados (pode adicionar v√°rios anos).
                </div>
                
                <div id="anosLetivos">
                    <!-- Anos ser√£o adicionados aqui dinamicamente -->
                </div>
                
                <div class="mb-3">
                    <button type="button" class="btn btn-success" id="btnAdicionarAno">
                        <i class="bi bi-plus-circle"></i> Adicionar Ano Letivo
                    </button>
                </div>
                
                <!-- Campo hidden para modalidade baseado no n√≠vel -->
                <input type="hidden" id="modalidade_id" name="modalidade_id">
            </div>
        </div>
    </div>

    <!-- Escola de Origem (Transfer√™ncia) -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">Escola de Origem (Apenas se for transfer√™ncia)</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8 mb-3">
                    <label for="escola_origem" class="form-label">Nome da Escola de Origem</label>
                    <input type="text" class="form-control" id="escola_origem" name="escola_origem">
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="municipio_origem" class="form-label">Munic√≠pio</label>
                    <input type="text" class="form-control" id="municipio_origem" name="municipio_origem">
                </div>
                
                <div class="col-md-1 mb-3">
                    <label for="uf_origem" class="form-label">UF</label>
                    <input type="text" class="form-control" id="uf_origem" name="uf_origem" maxlength="2">
                </div>
            </div>
        </div>
    </div>

    <!-- Observa√ß√µes -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">Observa√ß√µes e Op√ß√µes</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="exibir_faltas_frequencia" 
                           name="exibir_faltas_frequencia" value="1">
                    <label class="form-check-label" for="exibir_faltas_frequencia">
                        <strong>Exibir campos de Faltas e Frequ√™ncia</strong>
                        <small class="text-muted d-block">Marque se desejar controlar faltas e frequ√™ncia por disciplina</small>
                    </label>
                </div>
            </div>
            <textarea class="form-control" id="observacoes" name="observacoes" rows="3" 
                      placeholder="Informa√ß√µes adicionais sobre o hist√≥rico..."></textarea>
        </div>
    </div>

    <!-- Bot√µes -->
    <div class="d-flex justify-content-between mb-4">
        <a href="{{ url_for('historicos.listar') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Cancelar
        </a>
        <button type="submit" class="btn btn-info">
            <i class="bi bi-save"></i> Criar Hist√≥rico
        </button>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
let todasDisciplinas = [];
let contadorAnos = 0;

// Debug no submit do formul√°rio
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const anosCards = document.querySelectorAll('.ano-letivo-container');
        console.log(`üìù SUBMIT: Total de anos criados no formul√°rio: ${anosCards.length}`);
        anosCards.forEach((card, index) => {
            const anoInput = card.querySelector('.ano-input');
            const serieSelect = card.querySelector('.serie-select');
            const anoId = anoInput?.dataset.anoId;
            console.log(`  Ano #${index + 1} (ID: ${anoId}): ${anoInput?.value} - ${serieSelect?.value}`);
        });
    });
});
let √©Edicao = {% if √©_edicao %}true{% else %}false{% endif %};

// Dados do hist√≥rico para edi√ß√£o
{% if √©_edicao and historico %}
const dadosHistorico = {
    id: {{ historico.id }},
    nivel: '{{ historico.nivel }}',
    aluno_id: {{ historico.aluno_id }},
    modalidade_id: {{ historico.modalidade_id }},
    anos: [
        {% for ano_letivo in historico.anos_letivos %}
        {
            ano: {{ ano_letivo.ano }},
            serie: '{{ ano_letivo.serie }}',
            escola_id: {% if ano_letivo.escola_id %}{{ ano_letivo.escola_id }}{% else %}null{% endif %},
            disciplinas: [
                {% for disc_ano in ano_letivo.disciplinas %}
                {
                    disciplina_id: {{ disc_ano.disciplina_historica_id }},
                    disciplina_nome: '{{ disc_ano.disciplina_historica.nome }}',
                    nota: '{{ disc_ano.nota_final or "" }}'
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ]
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
};
console.log('üì¶ Dados do hist√≥rico carregados:', dadosHistorico);
{% else %}
const dadosHistorico = null;
{% endif %}

// ===== SISTEMA DE AUTO-SAVE =====
let historicoIdAtual = {% if historico %}{{ historico.id }}{% else %}null{% endif %};
let salvandoNoBanco = false;

// Salvar dados do formul√°rio NO BANCO DE DADOS
async function salvarFormularioBanco() {
    if (salvandoNoBanco) {
        console.log('‚è≥ Salvamento j√° em progresso...');
        return;
    }
    
    try {
        salvandoNoBanco = true;
        
        const nivel = document.getElementById('nivel')?.value;
        const aluno_id = document.getElementById('aluno_id')?.value;
        const modalidade_id = document.getElementById('modalidade_id')?.value;
        
        // Validar campos obrigat√≥rios
        if (!nivel || !aluno_id || !modalidade_id) {
            console.log('‚ö†Ô∏è Campos obrigat√≥rios n√£o preenchidos ainda');
            salvandoNoBanco = false;
            return;
        }
        
        // Verificar se h√° pelo menos um ano com dados v√°lidos
        const anosInputs = document.querySelectorAll('.ano-input');
        let temAnoValido = false;
        for (let anoInput of anosInputs) {
            const anoId = anoInput.dataset.anoId;
            const serieSelect = document.querySelector(`select.serie-select[data-ano-id="${anoId}"]`);
            const escolaSelect = document.querySelector(`select.escola-select[data-ano-id="${anoId}"]`);
            
            if (anoInput.value && serieSelect?.value && escolaSelect?.value) {
                temAnoValido = true;
                break;
            }
        }
        
        if (!temAnoValido) {
            console.log('‚ö†Ô∏è Nenhum ano letivo completo para salvar');
            salvandoNoBanco = false;
            return;
        }
        
        // Coletar dados dos anos
        const anos = [];
        document.querySelectorAll('.ano-input').forEach((anoInput) => {
            const anoId = anoInput.dataset.anoId;
            const serieSelect = document.querySelector(`select.serie-select[data-ano-id="${anoId}"]`);
            const escolaSelect = document.querySelector(`select.escola-select[data-ano-id="${anoId}"]`);
            
            if (anoInput.value && serieSelect?.value && escolaSelect?.value) {
                // Coletar disciplinas deste ano
                const disciplinasDoAno = [];
                const containerDisc = document.getElementById(`disciplinasAdicionadas_${anoId}`);
                
                if (containerDisc) {
                    containerDisc.querySelectorAll('[id^="disc_add_"]').forEach(div => {
                        const inputDiscId = div.querySelector('input[name*="[disciplina_id]"]');
                        const inputNota = div.querySelector('.nota-input');
                        
                        if (inputDiscId) {
                            disciplinasDoAno.push({
                                disciplina_id: parseInt(inputDiscId.value),
                                nota: inputNota?.value || null
                            });
                        }
                    });
                }
                
                anos.push({
                    ano: parseInt(anoInput.value),
                    serie: serieSelect.value,
                    escola_id: parseInt(escolaSelect.value),
                    disciplinas: disciplinasDoAno
                });
            }
        });
        
        const dadosFormulario = {
            historico_id: historicoIdAtual,
            aluno_id: parseInt(aluno_id),
            modalidade_id: parseInt(modalidade_id),
            nivel: nivel,
            anos: anos
        };
        
        console.log('üì§ Enviando para auto-save:', dadosFormulario);
        
        const response = await fetch('/historicos/auto-save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dadosFormulario)
        });
        
        const data = await response.json();
        
        if (data.success) {
            historicoIdAtual = data.historico_id;
            console.log('‚úÖ Auto-save conclu√≠do! ID:', historicoIdAtual);
            
            // Mostrar indicador de auto-save
            const alertAutoSave = document.getElementById('alertAutoSave');
            const spanUltimoSalvamento = document.getElementById('ultimoSalvamento');
            
            if (alertAutoSave) {
                alertAutoSave.style.display = 'block';
                const agora = new Date();
                const hora = agora.toLocaleTimeString('pt-BR');
                spanUltimoSalvamento.innerHTML = `<small class="text-muted">√öltimo salvamento: ${hora}</small>`;
            }
        } else {
            console.error('‚ùå Erro no auto-save:', data.message);
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao salvar:', error);
    } finally {
        salvandoNoBanco = false;
    }
}

// Aguardar o DOM carregar
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM carregado, inicializando eventos...');
    let primeiraVezNivel = true; // Flag para controlar primeira execu√ß√£o

    // Se for edi√ß√£o, carregar dados do hist√≥rico
    {% if √©_edicao and historico %}
    console.log('üîÑ Modo edi√ß√£o ativado');
    console.log('üì¶ Dados carregados:', dadosHistorico);
    document.getElementById('nivel').value = '{{ historico.nivel }}';
    document.getElementById('aluno_id').value = '{{ historico.aluno_id }}';
    document.getElementById('modalidade_id').value = '{{ historico.modalidade_id }}';
    {% endif %}

    // PASSO 1: Ao selecionar o N√çVEL, ajustar s√©rie e modalidade
    document.getElementById('nivel').addEventListener('change', function() {
        console.log('üéØ Evento change disparado no n√≠vel. primeiraVezNivel:', primeiraVezNivel, '√©Edicao:', √©Edicao);
        const nivel = this.value;
        const modalidadeInput = document.getElementById('modalidade_id');
        
        console.log('N√≠vel selecionado:', nivel);
        console.log('√â primeira vez?', primeiraVezNivel);
        console.log('√â edi√ß√£o?', √©Edicao);
        
        console.log('N√≠vel selecionado:', nivel);
        
        if (!nivel) {
            return;
        }
        
        // Definir modalidade baseada no n√≠vel
        if (nivel.includes('Supletivo')) {
            modalidadeInput.value = '2'; // ID do Supletivo
        } else if (nivel.includes('EJA')) {
            modalidadeInput.value = '3'; // ID do EJA
        } else {
            modalidadeInput.value = '1'; // ID do Regular
        }
        
        console.log('Modalidade definida:', modalidadeInput.value);
        
        // salvarFormularioBanco(); // Auto-save desativado
        
        // Definir s√©ries baseadas no n√≠vel
        let seriesDisponiveis = [];
        
        if (nivel === 'Fundamental 9 Anos') {
            seriesDisponiveis = [
                '1¬∫ Ano', '2¬∫ Ano', '3¬∫ Ano', '4¬∫ Ano', '5¬∫ Ano',
                '6¬∫ Ano', '7¬∫ Ano', '8¬∫ Ano', '9¬∫ Ano'
            ];
        } else if (nivel === 'Fundamental 8 S√©ries') {
            seriesDisponiveis = [
                '1¬™ S√©rie', '2¬™ S√©rie', '3¬™ S√©rie', '4¬™ S√©rie',
                '5¬™ S√©rie', '6¬™ S√©rie', '7¬™ S√©rie', '8¬™ S√©rie'
            ];
        } else if (nivel === 'Supletivo Fundamental' || nivel === 'EJA Fundamental') {
            seriesDisponiveis = [
                'Etapa I', 'Etapa II', 'Etapa III', 'Etapa IV', 'Etapa V',
                'Etapa VI', 'Etapa VII', 'Etapa VIII', 'Etapa IX'
            ];
        } else if (nivel === 'M√©dio') {
            seriesDisponiveis = ['1¬∫ Ano', '2¬∫ Ano', '3¬∫ Ano'];
        } else if (nivel === 'Supletivo M√©dio' || nivel === 'EJA M√©dio') {
            seriesDisponiveis = ['Etapa I', 'Etapa II', 'Etapa III'];
        }
        
        // Armazenar s√©ries dispon√≠veis globalmente
        window.seriesDisponiveis = seriesDisponiveis;
        
        // Limpar anos anteriores (apenas se N√ÉO for primeira vez na edi√ß√£o)
        if (!primeiraVezNivel || !√©Edicao) {
            document.getElementById('anosLetivos').innerHTML = '';
            contadorAnos = 0;
        }
        
        // Se for edi√ß√£o E primeira vez, carregar anos do hist√≥rico
        console.log('üîç Verificando condi√ß√µes:', {√©Edicao, primeiraVezNivel, temDados: !!dadosHistorico, qtdAnos: dadosHistorico?.anos?.length});
        if (√©Edicao && primeiraVezNivel && dadosHistorico && dadosHistorico.anos.length > 0) {
            console.log('‚úÖ Condi√ß√µes atendidas! Carregando', dadosHistorico.anos.length, 'anos do hist√≥rico...');
            dadosHistorico.anos.forEach((anoData, index) => {
                setTimeout(() => {
                    console.log(`üèóÔ∏è Criando ano ${index + 1} de ${dadosHistorico.anos.length}...`);
                    adicionarAnoLetivo();
                    
                    // Aguardar um pouco para garantir que o elemento foi criado no DOM
                    setTimeout(() => {
                        const todosContainers = document.querySelectorAll('.ano-letivo-container');
                        console.log(`üì¶ Total de containers encontrados: ${todosContainers.length}`);
                        const ultimoAnoContainer = todosContainers[index];
                        console.log(`üì¶ Container do ano ${index + 1} encontrado:`, !!ultimoAnoContainer);
                    if (ultimoAnoContainer) {
                        const anoId = ultimoAnoContainer.querySelector('.ano-input').dataset.anoId;
                        console.log(`üìñ Ano ${index + 1} (ID: ${anoId}):`, anoData);
                        
                        // Preencher dados do ano
                        document.querySelector(`input.ano-input[data-ano-id="${anoId}"]`).value = anoData.ano;
                        document.querySelector(`select.serie-select[data-ano-id="${anoId}"]`).value = anoData.serie;
                        if (anoData.escola_id) {
                            document.querySelector(`select.escola-select[data-ano-id="${anoId}"]`).value = anoData.escola_id;
                        }
                        
                        // Carregar disciplinas
                        console.log(`üìö Carregando ${anoData.disciplinas.length} disciplinas para o ano ${anoId}...`);
                        anoData.disciplinas.forEach(discData => {
                            console.log(`üîß Adicionando disciplina:`, discData);
                            const disciplina = {
                                id: discData.disciplina_id,
                                nome: discData.disciplina_nome
                            };
                            adicionarDisciplinaAoAno(anoId, disciplina);
                            
                            // Preencher nota
                            if (discData.nota) {
                                setTimeout(() => {
                                    const notaInput = document.querySelector(`#disciplinasAdicionadas_${anoId} input.nota-input[data-disciplina-id="${discData.disciplina_id}"]`);
                                    if (notaInput) {
                                        console.log(`üìù Preenchendo nota ${discData.nota} para disciplina ${discData.disciplina_id}`);
                                        notaInput.value = discData.nota;
                                    } else {
                                        console.error(`‚ùå Input de nota n√£o encontrado para disciplina ${discData.disciplina_id}`);
                                    }
                                }, 50);
                            }
                        });
                    }
                    }, 50); // Aguardar 50ms para o DOM atualizar
                }, index * 150); // Delay entre cada ano para garantir que sejam criados em ordem
            });
            primeiraVezNivel = false; // Marcar que j√° carregou
            
            // Ap√≥s carregar todos os dados da edi√ß√£o, permitir clonagem em novos anos
            setTimeout(() => {
                √©Edicao = false;
                console.log('‚úÖ Dados da edi√ß√£o carregados. Modo de cria√ß√£o ativado para novos anos.');
                console.log('üîÑ Clonagem de disciplinas ATIVADA para novos anos!');
            }, (dadosHistorico.anos.length * 150) + 300);
        } else if (!√©Edicao) {
            // Adicionar primeiro ano automaticamente (apenas para novo hist√≥rico)
            adicionarAnoLetivo();
        }
        
        // Marcar que j√° n√£o √© mais primeira vez
        if (primeiraVezNivel) {
            primeiraVezNivel = false;
        }
    });
    
    // Listener no aluno desativado
    // document.getElementById('aluno_id').addEventListener('change', function() {
    //     salvarFormularioBanco();
    // });

    // Auto-save peri√≥dico desativado para evitar erros
    // setInterval(function() {
    //     const aluno_id = document.getElementById('aluno_id')?.value;
    //     if (aluno_id) {
    //         console.log('‚è∞ Auto-save peri√≥dico (30s)');
    //         salvarFormularioBanco();
    //     }
    // }, 30000);

    // Disparar o evento change do n√≠vel para carregar anos (se for edi√ß√£o)
    if (√©Edicao && dadosHistorico) {
        setTimeout(() => {
            document.getElementById('nivel').dispatchEvent(new Event('change'));
        }, 100);
    }
    
    // Bot√£o adicionar ano
    document.getElementById('btnAdicionarAno').addEventListener('click', function() {
        adicionarAnoLetivo();
        // Salvar ap√≥s adicionar ano
        setTimeout(() => {
            salvarFormularioBanco();
        }, 500);
    });

    // Fun√ß√£o para adicionar um novo ano letivo
    function adicionarAnoLetivo() {
        // Buscar dados do ano anterior para clonar
        let anoAnterior = null;
        let disciplinasAnteriores = [];
        
        if (contadorAnos > 0) {
            // Pegar o √∫ltimo ano criado
            const ultimoAnoInput = document.querySelector(`.ano-input[data-ano-id="${contadorAnos}"]`);
            if (ultimoAnoInput && ultimoAnoInput.value) {
                anoAnterior = parseInt(ultimoAnoInput.value);
            }
            
            // Pegar as disciplinas do ano anterior
            const containerDiscAnteriores = document.getElementById(`disciplinasAdicionadas_${contadorAnos}`);
            if (containerDiscAnteriores) {
                containerDiscAnteriores.querySelectorAll('[id^="disc_add_"]').forEach(div => {
                    const inputDiscId = div.querySelector('input[name*="[disciplina_id]"]');
                    const strongNome = div.querySelector('strong');
                    
                    if (inputDiscId && strongNome) {
                        disciplinasAnteriores.push({
                            id: parseInt(inputDiscId.value),
                            nome: strongNome.textContent.trim()
                        });
                    }
                });
            }
        }
        
        contadorAnos++;
        const container = document.getElementById('anosLetivos');
        
        const anoCard = document.createElement('div');
        anoCard.className = 'card mb-3 ano-letivo-container';
        anoCard.id = `anoCard_${contadorAnos}`;
        anoCard.innerHTML = `
        <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
            <strong><i class="bi bi-calendar3"></i> Ano Letivo #${contadorAnos}</strong>
            ${contadorAnos > 1 ? `<button type="button" class="btn btn-sm btn-light" onclick="removerAnoLetivo(${contadorAnos})">
                <i class="bi bi-trash"></i> Remover
            </button>` : ''}
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">
                        <i class="bi bi-calendar"></i> Ano Letivo *
                    </label>
                    <input type="number" class="form-control ano-input" name="anos[${contadorAnos}][ano]" 
                           min="1960" max="2003" required data-ano-id="${contadorAnos}"
                           value="${anoAnterior ? anoAnterior + 1 : ''}">
                    <small class="text-muted">1960-2003</small>
                </div>
                
                <div class="col-md-3 mb-3">
                    <label class="form-label">
                        <i class="bi bi-mortarboard"></i> S√©rie/Ano/Etapa *
                    </label>
                    <select class="form-select serie-select" name="anos[${contadorAnos}][serie]" required data-ano-id="${contadorAnos}">
                        <option value="">Selecione...</option>
                        ${window.seriesDisponiveis.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label class="form-label">
                        <i class="bi bi-building"></i> Escola Cursada *
                    </label>
                    <select class="form-select escola-select" name="anos[${contadorAnos}][escola_id]" required data-ano-id="${contadorAnos}">
                        <option value="">Selecione...</option>
                        {% for escola in escolas %}
                        <option value="{{ escola.id }}">{{ escola.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <hr class="my-3">
            
            <!-- Buscar Disciplinas para este ano -->
            <div class="mb-3">
                <label class="form-label fw-bold text-success">
                    <i class="bi bi-book"></i> Disciplinas Cursadas
                </label>
                <div class="input-group mb-2">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control buscar-disciplina-ano" 
                           placeholder="Digite para buscar: matem√°tica, portugu√™s..." 
                           data-ano-id="${contadorAnos}"
                           autocomplete="off">
                    <button class="btn btn-primary btn-carregar-disciplinas" type="button" data-ano-id="${contadorAnos}">
                        <i class="bi bi-list"></i> Ver Todas
                    </button>
                    <button class="btn btn-success btn-nova-disciplina" type="button" data-ano-id="${contadorAnos}">
                        <i class="bi bi-plus-circle"></i> Nova
                    </button>
                </div>
                
                <!-- Autocomplete customizado -->
                <div id="autocomplete_${contadorAnos}" class="autocomplete-suggestions" style="display:none;"></div>
                
                <!-- Disciplinas adicionadas -->
                <div id="disciplinasAdicionadas_${contadorAnos}" class="mt-3">
                    <!-- Disciplinas com notas aparecer√£o aqui -->
                </div>
                
                <!-- Lista para sele√ß√£o (oculta inicialmente) -->
                <div id="listaDisciplinas_${contadorAnos}" class="lista-disciplinas-ano mt-2" style="display:none;">
                </div>
            </div>
        </div>
    `;
    
        container.appendChild(anoCard);
        
        // Adicionar listeners
        const anoInput = anoCard.querySelector('.ano-input');
        const serieSelect = anoCard.querySelector('.serie-select');
        const escolaSelect = anoCard.querySelector('.escola-select');
        const btnCarregar = anoCard.querySelector('.btn-carregar-disciplinas');
        const btnNova = anoCard.querySelector('.btn-nova-disciplina');
        const inputBusca = anoCard.querySelector('.buscar-disciplina-ano');
        
        anoInput.addEventListener('change', () => { 
            verificarAnosPreenchidos();
            // Salvar se ano, s√©rie e escola estiverem preenchidos
            if (anoInput.value && serieSelect.value && escolaSelect.value) {
                setTimeout(() => salvarFormularioBanco(), 500);
            }
        });
        serieSelect.addEventListener('change', () => { 
            verificarAnosPreenchidos();
            // Salvar se ano, s√©rie e escola estiverem preenchidos
            if (anoInput.value && serieSelect.value && escolaSelect.value) {
                setTimeout(() => salvarFormularioBanco(), 500);
            }
        });
        escolaSelect.addEventListener('change', () => { 
            verificarAnosPreenchidos();
            // Salvar se ano, s√©rie e escola estiverem preenchidos
            if (anoInput.value && serieSelect.value && escolaSelect.value) {
                setTimeout(() => salvarFormularioBanco(), 500);
            }
        });
        
        // Carregar disciplinas
        btnCarregar.addEventListener('click', () => carregarTodasDisciplinasAno(contadorAnos));
        
        // Nova disciplina
        btnNova.addEventListener('click', () => abrirModalNovaDisciplina(contadorAnos));
        
        // Autocomplete ao digitar
        inputBusca.addEventListener('input', function() {
            const termo = this.value.trim();
            const anoId = this.dataset.anoId;
            
            console.log('Digitando:', termo, 'Tamanho:', termo.length);
            
            if (termo.length >= 2) {
                console.log('Carregando sugest√µes para:', termo);
                carregarSugestoesCustomizadas(anoId, termo, this);
            } else {
                // Ocultar sugest√µes
                document.getElementById(`autocomplete_${anoId}`).style.display = 'none';
            }
        });
        
        // Ao pressionar Enter
        inputBusca.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const termo = this.value.trim();
                const anoId = this.dataset.anoId;
                
                if (termo) {
                    console.log('Enter pressionado - adicionando:', termo);
                    adicionarDisciplinaPorNome(anoId, termo);
                    this.value = '';
                    document.getElementById(`autocomplete_${anoId}`).style.display = 'none';
                }
            }
        });
        
        // Fechar sugest√µes ao clicar fora
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.buscar-disciplina-ano') && !e.target.closest('.autocomplete-suggestions')) {
                document.querySelectorAll('.autocomplete-suggestions').forEach(div => {
                    div.style.display = 'none';
                });
            }
        });
        
        // Clonar disciplinas do ano anterior (sem notas) - SOMENTE se n√£o for modo edi√ß√£o
        // No modo edi√ß√£o, as disciplinas j√° s√£o carregadas do banco de dados
        if (disciplinasAnteriores.length > 0 && !√©Edicao) {
            console.log(`üìã Clonando ${disciplinasAnteriores.length} disciplinas do ano anterior...`);
            disciplinasAnteriores.forEach((disc, index) => {
                setTimeout(() => {
                    adicionarDisciplinaAoAno(contadorAnos, disc);
                    console.log(`‚úÖ Disciplina clonada: ${disc.nome}`);
                }, index * 50); // Pequeno delay entre cada disciplina
            });
        }
        
        verificarAnosPreenchidos();
    }

    // Fun√ß√£o para remover um ano letivo
    function removerAnoLetivo(id) {
        const card = document.getElementById(`anoCard_${id}`);
        if (card) {
            card.remove();
            verificarAnosPreenchidos();
        }
    }

    // Verificar se pelo menos um ano est√° preenchido
    function verificarAnosPreenchidos() {
        const anosInputs = document.querySelectorAll('.ano-input');
        const seriesSelects = document.querySelectorAll('.serie-select');
        const escolasSelects = document.querySelectorAll('.escola-select');
        
        let algumPreenchido = false;
        
        for (let i = 0; i < anosInputs.length; i++) {
            if (anosInputs[i].value && seriesSelects[i].value && escolasSelects[i].value) {
                algumPreenchido = true;
                break;
            }
        }
        
        return algumPreenchido;
    }
    
    // Carregar sugest√µes customizadas (autocomplete bonito)
    function carregarSugestoesCustomizadas(anoId, termo, inputElement) {
        console.log('üîç carregarSugestoesCustomizadas - AnoId:', anoId, 'Termo:', termo);
        
        fetch('/disciplinas/api/todas')
            .then(response => response.json())
            .then(data => {
                const autocompleteDiv = document.getElementById(`autocomplete_${anoId}`);
                
                if (!autocompleteDiv) {
                    console.error('‚ùå Autocomplete div n√£o encontrado');
                    return;
                }
                
                autocompleteDiv.innerHTML = '';
                
                if (data.disciplinas) {
                    const termoLower = termo.toLowerCase();
                    const filtradas = data.disciplinas.filter(d => 
                        d.nome.toLowerCase().includes(termoLower)
                    ).slice(0, 10);
                    
                    console.log('‚ú® Disciplinas filtradas:', filtradas.length);
                    
                    if (filtradas.length > 0) {
                        filtradas.forEach(disc => {
                            const item = document.createElement('div');
                            item.className = 'autocomplete-item';
                            item.innerHTML = `<strong>${disc.nome}</strong>`;
                            if (disc.codigo) {
                                item.innerHTML += ` <span class="badge bg-secondary">${disc.codigo}</span>`;
                            }
                            
                            item.addEventListener('click', function() {
                                console.log('Clicou na sugest√£o:', disc.nome);
                                adicionarDisciplinaAoAno(anoId, disc);
                                inputElement.value = '';
                                autocompleteDiv.style.display = 'none';
                            });
                            
                            autocompleteDiv.appendChild(item);
                        });
                        
                        // Posicionar abaixo do input
                        const rect = inputElement.getBoundingClientRect();
                        autocompleteDiv.style.top = (inputElement.offsetTop + inputElement.offsetHeight) + 'px';
                        autocompleteDiv.style.left = inputElement.offsetLeft + 'px';
                        autocompleteDiv.style.width = inputElement.offsetWidth + 'px';
                        autocompleteDiv.style.display = 'block';
                    } else {
                        autocompleteDiv.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('‚ùå Erro ao carregar sugest√µes:', error);
            });
    }
    
    // Adicionar disciplina por nome (quando seleciona do autocomplete)
    function adicionarDisciplinaPorNome(anoId, nome) {
        console.log('üéØ adicionarDisciplinaPorNome - AnoId:', anoId, 'Nome:', nome);
        
        fetch('/disciplinas/api/todas')
            .then(response => response.json())
            .then(data => {
                console.log('Buscando disciplina com nome:', nome);
                
                const disciplina = data.disciplinas.find(d => 
                    d.nome.toLowerCase() === nome.toLowerCase()
                );
                
                if (disciplina) {
                    console.log('‚úÖ Disciplina encontrada:', disciplina);
                    adicionarDisciplinaAoAno(anoId, disciplina);
                } else {
                    console.warn('‚ö†Ô∏è Disciplina n√£o encontrada:', nome);
                    alert(`Disciplina "${nome}" n√£o encontrada. Use o bot√£o "Nova" para cadastrar.`);
                }
            })
            .catch(error => {
                console.error('‚ùå Erro:', error);
            });
    }
    
    // Carregar TODAS as disciplinas do banco para sele√ß√£o
    function carregarTodasDisciplinasAno(anoId) {
        const container = document.getElementById(`listaDisciplinas_${anoId}`);
        container.innerHTML = "<div class='text-center p-2'><div class='spinner-border spinner-border-sm text-primary'></div> Carregando...</div>";
        container.style.display = 'block';
        
        fetch('/disciplinas/api/todas')
            .then(response => response.json())
            .then(data => {
                if (data.disciplinas && data.disciplinas.length > 0) {
                    exibirListaSelecaoAno(anoId, data.disciplinas);
                } else {
                    container.innerHTML = `<div class="alert alert-warning alert-sm">Nenhuma disciplina encontrada.</div>`;
                }
            })
            .catch(error => {
                container.innerHTML = `<div class="alert alert-danger alert-sm">Erro: ${error.message}</div>`;
            });
    }
    
    // Exibir lista de todas as disciplinas para sele√ß√£o
    function exibirListaSelecaoAno(anoId, disciplinas) {
        const container = document.getElementById(`listaDisciplinas_${anoId}`);
        
        disciplinas.sort((a, b) => a.nome.localeCompare(b.nome));
        
        let html = `
            <div class="card">
                <div class="card-header bg-light py-2">
                    <strong>${disciplinas.length} disciplinas dispon√≠veis</strong>
                    <button type="button" class="btn btn-sm btn-secondary float-end" onclick="fecharListaAno(${anoId})">
                        <i class="bi bi-x"></i> Fechar
                    </button>
                </div>
                <div class="card-body p-2" style="max-height: 400px; overflow-y: auto;">
                    <div class="row g-2">
        `;
        
        disciplinas.forEach(disc => {
            html += `
                <div class="col-md-6">
                    <div class="p-2 border rounded hover-shadow" style="cursor:pointer;" 
                         onclick="adicionarDisciplinaAoAno(${anoId}, ${JSON.stringify(disc).replace(/"/g, '&quot;')})">
                        <strong>${disc.nome}</strong>
                        ${disc.codigo ? `<span class="badge bg-secondary ms-1">${disc.codigo}</span>` : ''}
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    // Fechar lista de sele√ß√£o
    function fecharListaAno(anoId) {
        document.getElementById(`listaDisciplinas_${anoId}`).style.display = 'none';
    }
    
    // Adicionar disciplina ao ano com campo de nota
    function adicionarDisciplinaAoAno(anoId, disciplina) {
        const container = document.getElementById(`disciplinasAdicionadas_${anoId}`);
        
        // Verificar se j√° foi adicionada
        if (document.getElementById(`disc_add_${anoId}_${disciplina.id}`)) {
            alert('Disciplina j√° adicionada!');
            return;
        }
        
        // Criar estrutura de 2 colunas se n√£o existir
        let rowContainer = container.querySelector('.row.disciplinas-grid');
        if (!rowContainer) {
            rowContainer = document.createElement('div');
            rowContainer.className = 'row disciplinas-grid g-2';
            container.appendChild(rowContainer);
        }
        
        const colDiv = document.createElement('div');
        colDiv.className = 'col-md-6';
        colDiv.id = `disc_add_${anoId}_${disciplina.id}`;
        
        colDiv.innerHTML = `
            <div class="p-2 border rounded bg-light">
                <div class="d-flex align-items-center gap-2">
                    <div class="flex-grow-1">
                        <strong>${disciplina.nome}</strong>
                        ${disciplina.codigo ? `<span class="badge bg-secondary ms-1">${disciplina.codigo}</span>` : ''}
                    </div>
                    <input type="hidden" name="anos[${anoId}][disciplinas][${disciplina.id}][disciplina_id]" value="${disciplina.id}">
                    <input type="text" class="form-control form-control-sm nota-input-compacto nota-input" 
                           name="anos[${anoId}][disciplinas][${disciplina.id}][nota]" 
                           placeholder="Nota"
                           pattern="^(10(\\.0)?|[0-9](\\.[0-9])?|A|EV|PD)$"
                           title="0.0-10.0, A, EV ou PD"
                           maxlength="4"
                           style="width: 70px;"
                           data-ano-id="${anoId}"
                           data-disciplina-id="${disciplina.id}">
                    <button type="button" class="btn btn-sm btn-danger" onclick="removerDisciplinaDoAno(${anoId}, ${disciplina.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <small class="text-muted d-block mt-1">Nota: 0.0-10.0, A, EV, PD</small>
            </div>
        `;
        
        rowContainer.appendChild(colDiv);
        
        // Adicionar listener para auto-save ao digitar nota
        const inputNota = colDiv.querySelector('.nota-input');
        inputNota.addEventListener('input', function() {
            validarNota(this);
        });
        // Auto-save desativado
        // inputNota.addEventListener('change', function() {
        //     salvarFormularioBanco();
        // });
        
        // Fechar lista de sele√ß√£o
        fecharListaAno(anoId);
        
        // Auto-save desativado
        // salvarFormularioBanco();
    }
    
    // Validar nota
    function validarNota(input) {
        const valor = input.value.toUpperCase().trim();
        
        // Aceitar valores v√°lidos
        if (valor === 'A' || valor === 'EV' || valor === 'PD' || valor === '') {
            input.setCustomValidity('');
            return;
        }
        
        // Validar n√∫mero
        const num = parseFloat(valor);
        if (!isNaN(num) && num >= 0 && num <= 10) {
            input.setCustomValidity('');
        } else {
            input.setCustomValidity('Digite nota de 0.0 a 10.0, ou A, EV, PD');
        }
    }
    
    // Remover disciplina do ano
    function removerDisciplinaDoAno(anoId, disciplinaId) {
        const elem = document.getElementById(`disc_add_${anoId}_${disciplinaId}`);
        if (elem) {
            elem.remove();
            // salvarFormularioBanco(); // Auto-save desativado
        }
    }
    
    // Abrir modal para criar nova disciplina
    let anoIdAtualModal = null;
    
    function abrirModalNovaDisciplina(anoId) {
        anoIdAtualModal = anoId;
        
        const nivelOriginal = document.getElementById('nivel').value;
        if (!nivelOriginal) {
            alert('Selecione primeiro o N√≠vel de Ensino');
            return;
        }
        
        // Pedir nome da disciplina
        const nomeDisciplina = prompt('Digite o nome da disciplina:');
        if (!nomeDisciplina || nomeDisciplina.trim() === '') return;
        
        const modalidadeId = document.getElementById('modalidade_id').value;
        const modalidadeNomes = {'1': 'Regular', '2': 'Supletivo', '3': 'EJA'};
        const modalidade = modalidadeNomes[modalidadeId] || 'Regular';
        const nivel = nivelOriginal.includes('Fundamental') ? 'Fundamental' : 'M√©dio';
        
        // Cadastrar disciplina
        fetch('/disciplinas/cadastrar_rapido', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                nome: nomeDisciplina.trim(),
                codigo: null,
                carga_horaria_padrao: 60,
                ano_inicio: 1960,
                nivel: nivel,
                modalidade: modalidade,
                ativa: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const disc = data.disciplina;
                
                // Adicionar disciplina √† lista do ano
                const container = document.getElementById(`listaDisciplinas_${anoId}`);
                const divRow = container.querySelector('.row');
                
                if (!divRow) {
                    // Se n√£o tem disciplinas ainda, criar estrutura completa
                    exibirDisciplinasAno(anoId, [disc]);
                } else {
                    // Adicionar √† lista existente
                    const novoItem = document.createElement('div');
                    novoItem.className = 'col-md-6 disciplina-item';
                    novoItem.innerHTML = `
                        <div class="form-check p-2 border rounded hover-shadow">
                            <input class="form-check-input disciplina-checkbox" type="checkbox" 
                                   name="anos[${anoId}][disciplinas][]" 
                                   value="${disc.id}" 
                                   id="disc_${anoId}_${disc.id}"
                                   data-ano-id="${anoId}"
                                   checked>
                            <label class="form-check-label w-100" for="disc_${anoId}_${disc.id}">
                                <strong>${disc.nome}</strong>
                            </label>
                        </div>
                    `;
                    divRow.appendChild(novoItem);
                    
                    // Adicionar listener
                    const checkbox = novoItem.querySelector('.disciplina-checkbox');
                    checkbox.addEventListener('change', function() {
                        atualizarContadorAno(anoId);
                        // salvarFormularioBanco(); // Auto-save desativado
                    });
                    
                    atualizarContadorAno(anoId);
                    // salvarFormularioBanco(); // Auto-save desativado
                }
                
                alert(`‚úÖ Disciplina "${disc.nome}" cadastrada e adicionada!`);
            } else {
                alert('Erro ao cadastrar: ' + data.message);
            }
        })
        .catch(error => {
            alert('Erro ao cadastrar disciplina: ' + error.message);
        });
    }
    
    // Expor fun√ß√µes globalmente
    window.removerAnoLetivo = removerAnoLetivo;
    window.fecharListaAno = fecharListaAno;
    window.adicionarDisciplinaAoAno = adicionarDisciplinaAoAno;
    window.removerDisciplinaDoAno = removerDisciplinaDoAno;

}); // Fechar DOMContentLoaded
</script>

<style>
.hover-shadow:hover {
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    background-color: #f8f9fa;
}
.alert-sm {
    padding: 0.5rem;
    font-size: 0.875rem;
}
.autocomplete-suggestions {
    position: absolute;
    background-color: #fff;
    border: 1px solid #198754;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
}
.autocomplete-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #e9ecef;
    transition: all 0.2s;
}
.autocomplete-item:hover {
    background-color: #d1e7dd;
    border-left: 4px solid #198754;
}
.autocomplete-item:last-child {
    border-bottom: none;
}
.nota-input {
    text-align: center;
    font-weight: bold;
}
.nota-input-compacto {
    text-align: center;
    font-weight: bold;
    min-width: 70px;
    max-width: 70px;
}
</style>
{% endblock %}
