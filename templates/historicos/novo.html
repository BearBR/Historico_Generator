{% extends "base.html" %}

{% block title %}Novo Histórico{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-file-earmark-plus"></i> Criar Novo Histórico</h2>
        <hr>
    </div>
</div>

<form method="POST">
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Informações do Histórico</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-primary">
                <i class="bi bi-info-circle"></i> <strong>Passo 1:</strong> Escolha primeiro o <strong>Nível</strong> (Fundamental/Médio/Supletivo/EJA) para carregar as opções corretas.
            </div>
            
            <div class="row">
                <!-- PASSO 1: NÍVEL -->
                <div class="col-md-12 mb-4">
                    <label for="nivel" class="form-label fs-5 text-primary">
                        <i class="bi bi-1-circle-fill"></i> Nível de Ensino *
                    </label>
                    <select class="form-select form-select-lg" id="nivel" name="nivel" required>
                        <option value="">Escolha o nível de ensino...</option>
                        <option value="Fundamental 9 Anos">Ensino Fundamental - 9 Anos (1º ao 9º)</option>
                        <option value="Fundamental 8 Séries">Ensino Fundamental - 8 Séries (1ª a 8ª)</option>
                        <option value="Médio">Ensino Médio</option>
                        <option value="Supletivo Fundamental">Supletivo - Ensino Fundamental</option>
                        <option value="Supletivo Médio">Supletivo - Ensino Médio</option>
                        <option value="EJA Fundamental">EJA - Ensino Fundamental</option>
                        <option value="EJA Médio">EJA - Ensino Médio</option>
                    </select>
                </div>
            </div>
            
            <hr class="my-4">
            
            <div id="camposAdicionais">
                <!-- PASSO 2: Dados do Aluno -->
                <div class="alert alert-primary">
                    <i class="bi bi-info-circle"></i> <strong>Passo 2:</strong> Selecione o <strong>Aluno</strong> para este histórico.
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-12 mb-3">
                        <label for="aluno_id" class="form-label fs-5 text-primary">
                            <i class="bi bi-2-circle-fill"></i> Aluno *
                        </label>
                        <select class="form-select form-select-lg" id="aluno_id" name="aluno_id" required>
                            <option value="">Selecione um aluno...</option>
                            {% for aluno in alunos %}
                            <option value="{{ aluno.id }}">{{ aluno.nome_completo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <!-- PASSO 3: Dados dos Anos Letivos -->
                <div class="alert alert-success">
                    <i class="bi bi-info-circle"></i> <strong>Passo 3:</strong> Adicione os <strong>Anos Letivos</strong> cursados (pode adicionar vários anos).
                </div>
                
                <div id="anosLetivos">
                    <!-- Anos serão adicionados aqui dinamicamente -->
                </div>
                
                <div class="mb-3">
                    <button type="button" class="btn btn-success" id="btnAdicionarAno">
                        <i class="bi bi-plus-circle"></i> Adicionar Ano Letivo
                    </button>
                </div>
                
                <!-- Campo hidden para modalidade baseado no nível -->
                <input type="hidden" id="modalidade_id" name="modalidade_id">
            </div>
        </div>
    </div>

    <!-- Buscar Disciplinas (Sempre Visível) -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="bi bi-search"></i> Buscar e Selecionar Disciplinas
            </h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-10">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="buscarDisciplina" 
                               placeholder="Digite para buscar: geografia, matemática, história...">
                        <button class="btn btn-outline-secondary" type="button" id="btnLimparBusca">
                            <i class="bi bi-x-circle"></i> Limpar
                        </button>
                        <button class="btn btn-primary" type="button" id="btnProcurarDisciplina">
                            <i class="bi bi-search"></i> Carregar Disciplinas
                        </button>
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filtroAno">
                        <option value="">Todos os Períodos</option>
                        <option value="1960-1971">1960-1971</option>
                        <option value="1971-1996">1971-1996</option>
                        <option value="1996-2003">1996-2003</option>
                    </select>
                </div>
            </div>
            
            <div id="listaDisciplinas">
                <div class="alert alert-info">
                    <i class="bi bi-lightbulb"></i> <strong>Como usar:</strong>
                    <ol class="mb-0 mt-2">
                        <li>Selecione o <strong>Nível de Ensino</strong> (Passo 1)</li>
                        <li>Clique em <strong>"Carregar Disciplinas"</strong></li>
                        <li><strong>Marque as disciplinas</strong> que o aluno cursou</li>
                        <li>Adicione os <strong>Anos Letivos</strong> abaixo</li>
                        <li>Clique em <strong>"Avançar"</strong> para lançar notas</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Escola de Origem (Transferência) -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">Escola de Origem (Apenas se for transferência)</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8 mb-3">
                    <label for="escola_origem" class="form-label">Nome da Escola de Origem</label>
                    <input type="text" class="form-control" id="escola_origem" name="escola_origem">
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="municipio_origem" class="form-label">Município</label>
                    <input type="text" class="form-control" id="municipio_origem" name="municipio_origem">
                </div>
                
                <div class="col-md-1 mb-3">
                    <label for="uf_origem" class="form-label">UF</label>
                    <input type="text" class="form-control" id="uf_origem" name="uf_origem" maxlength="2">
                </div>
            </div>
        </div>
    </div>

    <!-- Observações -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">Observações e Opções</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="exibir_faltas_frequencia" 
                           name="exibir_faltas_frequencia" value="1">
                    <label class="form-check-label" for="exibir_faltas_frequencia">
                        <strong>Exibir campos de Faltas e Frequência</strong>
                        <small class="text-muted d-block">Marque se desejar controlar faltas e frequência por disciplina</small>
                    </label>
                </div>
            </div>
            <textarea class="form-control" id="observacoes" name="observacoes" rows="3" 
                      placeholder="Informações adicionais sobre o histórico..."></textarea>
        </div>
    </div>

    <!-- Botões -->
    <div class="d-flex justify-content-between mb-4">
        <a href="{{ url_for('historicos.listar') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Cancelar
        </a>
        <button type="submit" class="btn btn-info">
            <i class="bi bi-save"></i> Criar Histórico
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
let todasDisciplinas = [];
let contadorAnos = 0;

// Aguardar o DOM carregar
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM carregado, inicializando eventos...');

    // PASSO 1: Ao selecionar o NÍVEL, ajustar série e modalidade
    document.getElementById('nivel').addEventListener('change', function() {
        const nivel = this.value;
        const modalidadeInput = document.getElementById('modalidade_id');
        
        console.log('Nível selecionado:', nivel);
        
        if (!nivel) {
            return;
        }
        
        // Definir modalidade baseada no nível
        if (nivel.includes('Supletivo')) {
            modalidadeInput.value = '2'; // ID do Supletivo
        } else if (nivel.includes('EJA')) {
            modalidadeInput.value = '3'; // ID do EJA
        } else {
            modalidadeInput.value = '1'; // ID do Regular
        }
        
        console.log('Modalidade definida:', modalidadeInput.value);
        
        // Definir séries baseadas no nível
        let seriesDisponiveis = [];
        
        if (nivel === 'Fundamental 9 Anos') {
            seriesDisponiveis = [
                '1º Ano', '2º Ano', '3º Ano', '4º Ano', '5º Ano',
                '6º Ano', '7º Ano', '8º Ano', '9º Ano'
            ];
        } else if (nivel === 'Fundamental 8 Séries') {
            seriesDisponiveis = [
                '1ª Série', '2ª Série', '3ª Série', '4ª Série',
                '5ª Série', '6ª Série', '7ª Série', '8ª Série'
            ];
        } else if (nivel === 'Supletivo Fundamental' || nivel === 'EJA Fundamental') {
            seriesDisponiveis = [
                'Etapa I', 'Etapa II', 'Etapa III', 'Etapa IV', 'Etapa V',
                'Etapa VI', 'Etapa VII', 'Etapa VIII', 'Etapa IX'
            ];
        } else if (nivel === 'Médio') {
            seriesDisponiveis = ['1º Ano', '2º Ano', '3º Ano'];
        } else if (nivel === 'Supletivo Médio' || nivel === 'EJA Médio') {
            seriesDisponiveis = ['Etapa I', 'Etapa II', 'Etapa III'];
        }
        
        // Armazenar séries disponíveis globalmente
        window.seriesDisponiveis = seriesDisponiveis;
        
        // Limpar anos anteriores
        document.getElementById('anosLetivos').innerHTML = '';
        contadorAnos = 0;
        
        // Adicionar primeiro ano automaticamente
        adicionarAnoLetivo();
    });

    // Botão adicionar ano
    document.getElementById('btnAdicionarAno').addEventListener('click', adicionarAnoLetivo);

    // Função para adicionar um novo ano letivo
    function adicionarAnoLetivo() {
        contadorAnos++;
        const container = document.getElementById('anosLetivos');
        
        const anoCard = document.createElement('div');
        anoCard.className = 'card mb-3';
        anoCard.id = `anoCard_${contadorAnos}`;
        anoCard.innerHTML = `
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <strong><i class="bi bi-calendar3"></i> Ano Letivo #${contadorAnos}</strong>
            ${contadorAnos > 1 ? `<button type="button" class="btn btn-sm btn-danger" onclick="removerAnoLetivo(${contadorAnos})">
                <i class="bi bi-trash"></i> Remover
            </button>` : ''}
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">
                        <i class="bi bi-calendar"></i> Ano Letivo *
                    </label>
                    <input type="number" class="form-control ano-input" name="anos[${contadorAnos}][ano]" 
                           min="1960" max="2003" required data-ano-id="${contadorAnos}">
                    <small class="text-muted">1960-2003</small>
                </div>
                
                <div class="col-md-3 mb-3">
                    <label class="form-label">
                        <i class="bi bi-mortarboard"></i> Série/Ano/Etapa *
                    </label>
                    <select class="form-select serie-select" name="anos[${contadorAnos}][serie]" required data-ano-id="${contadorAnos}">
                        <option value="">Selecione...</option>
                        ${window.seriesDisponiveis.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label class="form-label">
                        <i class="bi bi-building"></i> Escola Cursada *
                    </label>
                    <select class="form-select escola-select" name="anos[${contadorAnos}][escola_id]" required data-ano-id="${contadorAnos}">
                        <option value="">Selecione...</option>
                        {% for escola in escolas %}
                        <option value="{{ escola.id }}">{{ escola.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    `;
    
        container.appendChild(anoCard);
        
        // Adicionar listeners para verificar preenchimento
        anoCard.querySelector('.ano-input').addEventListener('change', verificarAnosPreenchidos);
        anoCard.querySelector('.serie-select').addEventListener('change', verificarAnosPreenchidos);
        anoCard.querySelector('.escola-select').addEventListener('change', verificarAnosPreenchidos);
        
        verificarAnosPreenchidos();
    }

    // Função para remover um ano letivo
    function removerAnoLetivo(id) {
        const card = document.getElementById(`anoCard_${id}`);
        if (card) {
            card.remove();
            verificarAnosPreenchidos();
        }
    }

    // Verificar se pelo menos um ano está preenchido
    function verificarAnosPreenchidos() {
        // Esta função agora apenas valida - não precisa mais mostrar/ocultar card de disciplinas
        const anosInputs = document.querySelectorAll('.ano-input');
        const seriesSelects = document.querySelectorAll('.serie-select');
        const escolasSelects = document.querySelectorAll('.escola-select');
        
        let algumPreenchido = false;
        
        for (let i = 0; i < anosInputs.length; i++) {
            if (anosInputs[i].value && seriesSelects[i].value && escolasSelects[i].value) {
                algumPreenchido = true;
                break;
            }
        }
        
        // Apenas retorna se está preenchido (para uso futuro se necessário)
        return algumPreenchido;
    }

    // Atualizar seções de disciplinas para cada ano (mantida para compatibilidade)
    function atualizarDisciplinasPorAno() {
        // Função desativada - disciplinas agora são selecionadas globalmente
        return;
    }

    // Buscar disciplina por nome
    const inputBuscar = document.getElementById('buscarDisciplina');
    if (inputBuscar) {
        inputBuscar.addEventListener('input', function() {
            const termo = this.value.toLowerCase().trim();
            console.log('Buscando por:', termo, '| Total disciplinas carregadas:', todasDisciplinas.length);
            
            if (termo.length >= 2) {
                const disciplinasFiltradas = todasDisciplinas.filter(d => 
                    d.nome.toLowerCase().includes(termo) || 
                    (d.codigo && d.codigo.toLowerCase().includes(termo))
                );
                console.log('Disciplinas filtradas:', disciplinasFiltradas.length);
                exibirDisciplinas(disciplinasFiltradas);
            } else if (termo.length === 0) {
                console.log('Termo vazio, exibindo todas');
                exibirDisciplinas(todasDisciplinas);
            }
        });
    }

    // Filtro por período
    const filtroAno = document.getElementById('filtroAno');
    if (filtroAno) {
        filtroAno.addEventListener('change', function() {
            const periodo = this.value;
            
            if (!periodo) {
                exibirDisciplinas(todasDisciplinas);
                return;
            }
            
            const [anoInicio, anoFim] = periodo.split('-').map(Number);
            const disciplinasFiltradas = todasDisciplinas.filter(d => {
                if (!d.ano_inicio) return false;
                
                if (anoFim) {
                    return d.ano_inicio >= anoInicio && d.ano_inicio <= anoFim;
                } else {
                    return d.ano_inicio >= anoInicio;
                }
            });
            
            exibirDisciplinas(disciplinasFiltradas);
        });
    }

    // Limpar busca
    const btnLimpar = document.getElementById('btnLimparBusca');
    if (btnLimpar) {
        btnLimpar.addEventListener('click', function() {
            console.log('Botão Limpar clicado');
            document.getElementById('buscarDisciplina').value = '';
            document.getElementById('filtroAno').value = '';
            console.log('Exibindo todas as disciplinas:', todasDisciplinas.length);
            exibirDisciplinas(todasDisciplinas);
        });
    }

    // Botão Procurar Disciplina - carregar disciplinas e focar na busca
    const btnProcurar = document.getElementById('btnProcurarDisciplina');
    if (btnProcurar) {
        btnProcurar.addEventListener('click', function() {
            console.log('Botão Procurar Disciplina clicado!');
            const nivelOriginal = document.getElementById('nivel').value;
            const modalidadeId = document.getElementById('modalidade_id').value;
            
            console.log('Nível:', nivelOriginal, 'Modalidade ID:', modalidadeId);
            
            if (!nivelOriginal) {
                alert('Por favor, escolha primeiro o Nível de Ensino');
                document.getElementById('nivel').focus();
                return;
            }
            
            // Carregar todas as disciplinas do nível selecionado (ano 1980 como padrão)
            const modalidadeNomes = {'1': 'Regular', '2': 'Supletivo', '3': 'EJA'};
            const modalidade = modalidadeNomes[modalidadeId] || 'Regular';
            const nivel = nivelOriginal.includes('Fundamental') ? 'Fundamental' : 'Médio';
            
            const url = `/disciplinas/api/carregar-grade?ano=1980&modalidade=${modalidade}&nivel=${nivel}`;
            console.log('URL da API:', url);
            
            carregarDisciplinas(url);
            
            // Focar na busca após carregar
            setTimeout(() => {
                document.getElementById('buscarDisciplina').focus();
                document.getElementById('buscarDisciplina').select();
            }, 500);
        });
    }

    function carregarDisciplinas(url) {
        console.log('carregarDisciplinas chamada com URL:', url);
        const container = document.getElementById('listaDisciplinas');
        container.innerHTML = "<div class='text-center'><div class='spinner-border text-primary' role='status'><span class='visually-hidden'>Carregando...</span></div><p class='mt-2'>Carregando disciplinas...</p></div>";
        
        fetch(url)
            .then(response => {
                console.log('Resposta recebida:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Dados JSON:', data);
                console.log('Total de disciplinas:', data.disciplinas ? data.disciplinas.length : 0);
                if (data.disciplinas && data.disciplinas.length > 0) {
                    todasDisciplinas = data.disciplinas;
                    exibirDisciplinas(data.disciplinas);
                } else {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 
                            Nenhuma disciplina encontrada.
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Erro ao carregar disciplinas:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> Erro ao carregar disciplinas: ${error.message}
                    </div>
                `;
            });
    }

    function exibirDisciplinas(disciplinas) {
        const container = document.getElementById('listaDisciplinas');
        
        if (disciplinas.length === 0) {
            container.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> Nenhuma disciplina encontrada com os filtros aplicados.
                </div>
            `;
            return;
        }
        
        // Ordenar alfabeticamente
        disciplinas.sort((a, b) => a.nome.localeCompare(b.nome));
        
        let html = `
            <div class="alert alert-success mb-3">
                <i class="bi bi-check-circle"></i> <strong>${disciplinas.length} disciplinas</strong> disponíveis
                <span class="ms-3 text-dark">
                    | <strong id="total-selecionadas">0</strong> selecionadas
                </span>
            </div>
            <div class="mb-3">
                <button type="button" class="btn btn-sm btn-primary" onclick="selecionarTodas()">
                    <i class="bi bi-check-all"></i> Selecionar Todas
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="desmarcarTodas()">
                    <i class="bi bi-x-circle"></i> Desmarcar Todas
                </button>
            </div>
            <div class="row g-2">
        `;
        
        disciplinas.forEach(disc => {
            html += `
                <div class="col-md-6">
                    <div class="form-check p-2 border rounded hover-shadow">
                        <input class="form-check-input disciplina-checkbox" type="checkbox" 
                               name="disciplinas_selecionadas[]" 
                               value="${disc.id}" 
                               id="disc_${disc.id}">
                        <label class="form-check-label w-100" for="disc_${disc.id}">
                            <strong>${disc.nome}</strong>
                            ${disc.codigo ? `<span class="badge bg-secondary ms-1">${disc.codigo}</span>` : ''}
                            ${disc.carga_horaria_padrao ? `<br><small class="text-muted">CH: ${disc.carga_horaria_padrao}h</small>` : ''}
                        </label>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        
        // Adicionar listener para atualizar contador
        document.querySelectorAll('.disciplina-checkbox').forEach(cb => {
            cb.addEventListener('change', atualizarContador);
        });
    }

    function selecionarTodas() {
        document.querySelectorAll('.disciplina-checkbox').forEach(cb => cb.checked = true);
        atualizarContador();
    }

    function desmarcarTodas() {
        document.querySelectorAll('.disciplina-checkbox').forEach(cb => cb.checked = false);
        atualizarContador();
    }

    function atualizarContador() {
        const total = document.querySelectorAll('.disciplina-checkbox:checked').length;
        const elem = document.getElementById('total-selecionadas');
        if (elem) elem.textContent = total;
    }
    
    // Expor funções globalmente para onclick
    window.removerAnoLetivo = removerAnoLetivo;
    window.selecionarTodas = selecionarTodas;
    window.desmarcarTodas = desmarcarTodas;

}); // Fechar DOMContentLoaded
</script>

<style>
.hover-shadow:hover {
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    background-color: #f8f9fa;
}
</style>
{% endblock %}
