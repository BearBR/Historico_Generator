{% extends "base.html" %}

{% block title %}Histórico - {{ historico.aluno.nome_completo }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-file-earmark-text"></i> Histórico Escolar Completo</h2>
        <hr>
    </div>
</div>

<!-- Dados do Aluno -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-person"></i> Dados do Aluno</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>Nome:</strong> {{ historico.aluno.nome_completo }}</p>
                <p><strong>Data de Nascimento:</strong> {{ historico.aluno.data_nascimento.strftime('%d/%m/%Y') if historico.aluno.data_nascimento else '-' }}</p>
                <p><strong>CPF:</strong> {{ historico.aluno.cpf or '-' }}</p>
                <p><strong>RG:</strong> {{ historico.aluno.rg or '-' }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Naturalidade:</strong> {{ historico.aluno.naturalidade or '-' }}/{{ historico.aluno.uf_nascimento or '-' }}</p>
                <p><strong>Nome da Mãe:</strong> {{ historico.aluno.nome_mae or '-' }}</p>
                <p><strong>Nome do Pai:</strong> {{ historico.aluno.nome_pai or '-' }}</p>
                <p><strong>Nível:</strong> <span class="badge bg-info">{{ historico.nivel }}</span></p>
            </div>
        </div>
    </div>
</div>

<!-- Anos Letivos -->
{% for ano_letivo in historico.anos_letivos|sort(attribute='ano') %}
<div class="card mb-4">
    <div class="card-header" style="background-color: #0dcaf0; color: white;">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-calendar3"></i> {{ ano_letivo.ano }} - {{ ano_letivo.serie }}
            </h5>
            <span class="badge bg-light text-dark">
                {{ ano_letivo.disciplinas|length }} disciplinas
            </span>
        </div>
    </div>
    <div class="card-body">
        <!-- Dados da Escola -->
        <div class="row mb-3">
            <div class="col-md-8">
                <p class="mb-1"><strong>Escola:</strong> {{ ano_letivo.escola.nome }}</p>
                <p class="mb-1"><small class="text-muted">{{ ano_letivo.escola.endereco }}, {{ ano_letivo.escola.municipio }}/{{ ano_letivo.escola.estado }}</small></p>
            </div>
            <div class="col-md-4 text-end">
                <p class="mb-1"><strong>Período:</strong> 
                    {% if ano_letivo.data_inicio and ano_letivo.data_termino %}
                        {{ ano_letivo.data_inicio.strftime('%d/%m/%Y') }} a {{ ano_letivo.data_termino.strftime('%d/%m/%Y') }}
                    {% else %}
                        -
                    {% endif %}
                </p>
                <p class="mb-1"><strong>Dias Letivos:</strong> {{ ano_letivo.dias_letivos or '-' }}</p>
                <p class="mb-1"><strong>CH Total:</strong> {{ ano_letivo.carga_horaria_total or '-' }} horas</p>
            </div>
        </div>

        <!-- Disciplinas do Ano -->
        {% if ano_letivo.disciplinas %}
        <div class="table-responsive">
            <table class="table table-sm table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Disciplina</th>
                        <th class="text-center" style="width: 100px;">Nota Final</th>
                        {% if historico.exibir_faltas_frequencia %}
                        <th class="text-center" style="width: 80px;">Faltas</th>
                        <th class="text-center" style="width: 80px;">Freq. %</th>
                        {% endif %}
                        <th class="text-center" style="width: 100px;">Resultado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for disc in ano_letivo.disciplinas %}
                    <tr>
                        <td>{{ disc.disciplina_historica.nome }}</td>
                        <td class="text-center">
                            <strong>{{ '%.1f' % disc.nota_final if disc.nota_final else '-' }}</strong>
                        </td>
                        {% if historico.exibir_faltas_frequencia %}
                        <td class="text-center">{{ disc.faltas }}</td>
                        <td class="text-center">{{ '%.1f' % disc.frequencia if disc.frequencia else '-' }}</td>
                        {% endif %}
                        <td class="text-center">
                            {% if disc.resultado == 'A' %}
                                <span class="badge bg-success">Aprovado</span>
                            {% elif disc.resultado == 'R' %}
                                <span class="badge bg-danger">Reprovado</span>
                            {% else %}
                                <span class="badge bg-warning text-dark">Pendente</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-warning mb-0">
            <i class="bi bi-exclamation-triangle"></i> Nenhuma disciplina cadastrada para este ano letivo.
        </div>
        {% endif %}

        <!-- Resultado Final do Ano -->
        {% if ano_letivo.resultado_final %}
        <div class="alert alert-info mb-0 mt-3">
            <strong>Resultado Final:</strong> 
            <span class="badge bg-primary">{{ ano_letivo.resultado_final.codigo }}</span> 
            {{ ano_letivo.resultado_final.descricao }}
        </div>
        {% endif %}
    </div>
</div>
{% endfor %}

<!-- Conclusão de Curso -->
{% if historico.conclusao_curso %}
<div class="card mb-4 border-success">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="bi bi-award"></i> Conclusão de Curso</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>Data de Conclusão:</strong> {{ historico.data_conclusao.strftime('%d/%m/%Y') if historico.data_conclusao else '-' }}</p>
                <p><strong>Número do Certificado:</strong> {{ historico.numero_certificado or '-' }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Livro de Registro:</strong> {{ historico.livro_registro or '-' }}</p>
                <p><strong>Folha de Registro:</strong> {{ historico.folha_registro or '-' }}</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Assinaturas -->
{% if historico.nome_diretor or historico.nome_secretario %}
<div class="card mb-4">
    <div class="card-header bg-secondary text-white">
        <h5 class="mb-0"><i class="bi bi-pen"></i> Assinaturas</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>Diretor(a):</strong> {{ historico.nome_diretor or '-' }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Secretário(a):</strong> {{ historico.nome_secretario or '-' }}</p>
            </div>
        </div>
        <p class="mb-0"><strong>Data de Emissão:</strong> {{ historico.data_emissao.strftime('%d/%m/%Y') if historico.data_emissao else '-' }}</p>
    </div>
</div>
{% endif %}

<!-- Botões de Ação -->
<div class="d-flex justify-content-between mb-5">
    <a href="{{ url_for('historicos.listar') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
    <div>
        <a href="{{ url_for('historicos.lancar_notas', id=historico.id) }}" class="btn btn-warning me-2">
            <i class="bi bi-pencil"></i> Editar Notas
        </a>
        <a href="{{ url_for('historicos.gerar_pdf', id=historico.id) }}" class="btn btn-danger">
            <i class="bi bi-file-pdf"></i> Gerar PDF
        </a>
    </div>
</div>

{% endblock %}
